<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" href = "https://ifh.cc/g/nN9xc5.png">
  <link rel="stylesheet" href="/front/css/style.css">
  <title>ì„±ë‚¨.ai : ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”</title>
</head>
<body>

<div id = "firstLoading">
  <div>
    <img src="https://ifh.cc/g/nN9xc5.png" class = "logo"/>
    <div>SNAM.ai</div>
  </div>
</div>

<section>
<header>
  <img src="https://ifh.cc/g/nN9xc5.png" id = "logo"/>
  <span style = "margin-left:5px;font-weight:bold;">ì„±ë‚¨.ai</span>
  <span style = "margin-left:5px;opacity:0.3;font-size:0.8em;font-weight:bold;height:100%;display:flex;align-items:center;padding-top:2.5px;"> : ì§„ë¡œ â€¢ ì·¨ì—… â€¢ ì •ì±… ìƒë‹´</span>
  <img src="https://ifh.cc/g/8SYcDo.png" id = "sideUp" onclick = "aboutMe();">
</header>
<main>
  
</main>
<aside>
  <textarea placeholder="ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”" autofocus ></textarea>
  <div><button><img src="https://ifh.cc/g/lNXYYf.png"/></button></div>
</aside>
</section>
<div id = "sideUpWindow"></div>
<div style = "position:absolute;bottom: 5px; opacity: 0.5; width: 100vw;display:flex;justify-content:center;font-size: 10px;">ì„±ë‚¨.ai ëŠ” ê°™ì€ë§ì„ ë°˜ë³µí•  ìˆ˜ ìˆì–´ìš”. ì´ì  ì–‘í•´ ë¶€íƒë“œë ¤ìš”</div>
<script>
let EfetchWaiter = true
let EfetchTimeWaiter = true;
let username = 'ì‚¬ìš©ì'
let context = 'ì•„ì§ ë§¥ë½ì—†ìŒ'
let before = 'aiê°€ ì‚¬ìš©ìì—ê²Œ ìµœì´ˆë¡œ, ì¸ì‚¬ ë° ìê¸°ì†Œê°œë¥¼ ì™„ë£Œí•˜ê³  ì—´ì‹¬íˆ ë‹µë³€í•˜ê² ë‹¤í•¨'
//ìœ í‹¸ë¦¬í‹°
const $ = (n) => document.querySelector(n);
async function typeText(name, content, speed=30) {
      const element = $(name);
      if (!element) {
        console.error(`${name}ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        return;
      }
      const scroll = setInterval(()=>{scrollTo()},500)
      let processedContent = '';
      let index = 0;

      while (index < content.length) {
        const char = content[index];

        if (char === '<') {
          processedContent += char;
          index++;
          while (content[index] !== '>' && index < content.length) {
            processedContent += content[index];
            index++;
          }
          processedContent += '>';
        } else {
          processedContent += char;
        }

        element.innerHTML = processedContent + 'â—'; 
        if (content[index] !== ' ') {
          await new Promise((resolve) => setTimeout(resolve, speed));
        }

        index++;
      }
      element.innerHTML = processedContent;
      return  clearInterval(scroll)
    }


async function Efetch(path, headers = {}, body = null, print = (typeof test !== 'undefined'?test:false), delay = 100) {
await wait(()=>EfetchWaiter)
if (!EfetchTimeWaiter) return clearInverval(scroll);
EfetchWaiter = false;
EfetchTimeWaiter = false;

try {
  const isPost = !!body;

  if (isPost && !headers["Content-Type"]) {
    headers["Content-Type"] = "application/json";
  }

  const res = await fetch('/' + path, {
    method: isPost ? 'POST' : 'GET',
    headers,
    body: isPost ? JSON.stringify(body) : null,
  });
  if(res.status === 429)return alarm('ì›Œì›Œ, ì¡°ê¸ˆ ì²œì²œíˆ í•´ì£¼ì„¸ìš”')

  const data = await res.json();
  if (print) console.log(`/${path} res:`, data);
  return data;

} catch (error) {
  console.error(`/${path} res ERROR:`, error);
  return null;
} finally {
  setTimeout(() => {
    EfetchTimeWaiter = true;
    EfetchWaiter = true;
  }, delay);
}
}

function wait(b) {
return new Promise((resolve) => {
  const check = () => {
    if (b()) return resolve();
    setTimeout(check, 30);
  };
  check();
});
}

function scrollTo(){
  document.querySelector('main').scrollTo({
top: document.querySelector('main').scrollHeight,
behavior: 'smooth'
});
}

function random(min, max) {
  const time = Date.now();
  let seed = time ^ (time >> 3);
  seed = (seed * 9301 + 49297) % 233280;
  const randomValue = seed / 233280 + Math.random();
  return Math.floor((randomValue % 1) * (max - min + 1)) + min;
}

function textEF(content) {
  return content
    .replace(/@[^@\s]{1,30}(?=\s|$)/g, m => `<span class='mention'>${m}</span>`)
    .replace(/(https?:\/\/[^\s]+|www\.[^\s]+)/g, m => 
      m.includes("i.ibb") ? m :
      `<span><a href="${m}" ${m.includes(location.origin)?'':`target="_blank"`} class="link">${m}</a></span>`
    )
    .replace(/__(.+?)__/gs, (_, p1) => `<span style='text-decoration: underline;'>${p1}</span>`)
    .replace(/\*\*([\s\S]*?)\*\*/g, (_, p1) => `<span style='font-weight:940;'>${p1}</span>`)
    .replace(/~~([\s\S]*?)~~/g, (_, p1) => `<span style='text-decoration: line-through;'>${p1}</span>`)
    .replace(/--([\s\S]*?)--/g, (_, p1) => `<span style='background-color:rgba(255,219,101,0.69);border-radius:5px;padding:2px;color:black;'>${p1}</span>`)
    .replace(/#([\s\S]*?)#/g, (_, p1) => `<span style="font-size:1.3em;">${p1}</span>`)
    .replaceAll("$br$", "<br>")
    .replaceAll("$sp$", "");
}


let aiLimit = true;
async function fetchAI(input, log) {
  if (!aiLimit) return "timeLimit";
  aiLimit = false;
  let r = await Efetch('ai',undefined,{data:{content:input,context:context,before:before,username:username}},false)
  aiLimit = true
  return r;
}

function makeChat(content, who='ai', animate=true, scroll=true) {
  const chat = document.createElement('section');
  const id = 'chat-' + Date.now().toString(36);
  const prof = `<span><img src="${who=='ai'?'https://ifh.cc/g/LQ0VPG.png':'https://ifh.cc/g/cdXtco.png'}" style="display:block;"/></span>`;
  const bubble = `<div class="bubble" style="border-radius:${who==='ai'?'2px 20px 20px 20px':'20px 2px 20px 20px;margin-left:auto;'}">${textEF(content)}</div>`;
  chat.innerHTML = who==='ai' ? `${prof}${bubble}` : `${bubble}${prof}`;
  chat.className = who;
  chat.id = id;
  if (animate) chat.style.animation = `showChat${who==='ai'?'L':'R'} 1s ease`;
  $('main').appendChild(chat);
  if(scroll)scrollTo()
  return id;
}

//modal Alarm
function bigAlarm(content, buttons = ['í™•ì¸', 'ì·¨ì†Œ'], callback = () => {}) {
const id = Date.now().toString(36);
if (typeof content !== 'object') content = ['', content];

const close = () => {
  const modal = document.getElementById(`al${id}`);
  if (!modal) return;
  const buttons = modal.querySelectorAll('button');
  buttons.forEach(btn => btn.style.pointerEvents = 'none');
  modal.style.opacity = '0';
  setTimeout(() => modal.remove(), 500);
};

const modal = document.createElement('div');
modal.className = 'bigAlarm';
modal.id = `al${id}`;
modal.innerHTML = `
  <div>
    ${content[0] ? `<div class="title">${textEF(content[0])}</div>` : ''}
    <div${!content[0] ? ' style="font-size:1rem;opacity:1"' : ''}>${textEF(content[1])}</div>
    <article>
      <button class="highB" id="okBtn${id}">${textEF(buttons[0])}</button>
      <button id="cancelBtn${id}">${textEF(buttons[1])}</button>
    </article>
  </div>`;

modal.onclick = (e) => {
  if (e.target === modal) document.getElementById(`cancelBtn${id}`).click();
};
modal.querySelector('div').onclick = (e) => e.stopPropagation();

document.body.appendChild(modal);

document.getElementById(`okBtn${id}`).onclick = () => {
  close();
  callback();
};
document.getElementById(`cancelBtn${id}`).onclick = close;
}

//ì“°ë ¤ê³  ë§Œë“  í•¨ìˆ˜
const Storage = {
  setSession:(k,v) => sessionStorage.setItem(k,v),
  getSession:(k) => sessionStorage.getItem(k),
  setLocal:(k,v) => localStorage.setItem(k,v),
  getLocal:(k) => localStorage.getItem(k)
};

//input
let schools = {};

function start() {
  const ta = $('aside textarea');
  const phList = [
    'ì§„ë¡œì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”',
    'ì„±ë‚¨ì— ì ì ˆí•œ ì§ì—…, ì§„ë¡œë¥¼ ë¬¼ì–´ë´ìš”',
    'ì–´ë–¤ ì§„ë¡œê°€ ë§ì„ì§€ ê³ ë¯¼ë˜ì‹œë‚˜ìš”?',
    'ì„±ë‚¨ì˜ ì·¨ì—…ì •ë³´ë¥¼ ì•Œì•„ë´ìš”',
    'ì„±ë‚¨ì‹œì— ê´€í•´ ë¬¼ì–´ë³´ì„¸ìš”!',
    'ì„±ë‚¨ì‹œëŠ” ë…¸ì¸ë¶„ë“¤ì„ ì–´ì°Œ ì§€ì›í• ê¹Œìš”?',
    'ì„±ë‚¨ì‹œì˜ ì´ˆë“±í•™êµ ê°œìˆ˜ëŠ”?',
    'ì„±ë‚¨ì‹œì— ëŒ€í•´ ê¶ê¸ˆí•œ ê²ƒì´ ìˆìœ¼ì‹ ê°€ìš”?',
  ];
  ta.placeholder = phList[random(0,phList.length-1)];

  ta.addEventListener('input', () => {
    ta.style.height = '30px';
    ta.style.height = Math.min(ta.scrollHeight, 120) + 'px';
  });

  ta.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) e.preventDefault();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') $('div button').click();
  });

  $('div button').onclick = async () => {//ì±„íŒ…ë°œìƒ

    let input = ta.value.trim();
    if (!input) return;
    makeChat(input, 'me');
    let chat = makeChat('<div style = "width: 100%;display:flex;justify-content:center;"><div class="loading"></div></div><div  style = "width: 100%;display:flex;justify-content:center;"> ì¶”ê°€ì •ë³´ ì¡°íšŒì¤‘</div>');
    ta.value = '';
    ta.style.height = '30px';

    // Efetch í˜¸ì¶œ ê²°ê³¼ë¥¼ resDataì— ì €ì¥
    let resData = await Efetch('ai', undefined, { data: { content: input, context: context, before: before, username: username } }, false);
    // resData.rì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  res ë³€ìˆ˜ì— í• ë‹¹
    let res = resData && resData.r;

    if (!res) {
      $(`#${chat} .bubble`).innerHTML = 'ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
      return;
    }

    let parsed;
    try {
      const cleanRes = res.replace(/```json\s*|```/g, '').trim(); //ì œë¯¸ë‚˜ì´ì˜ ì‹¤ìˆ˜ ì²˜ë¦¬
      parsed = JSON.parse(cleanRes);
    } catch (e) {
      console.error("AI ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", e);
      parsed = { ì‘ë‹µ: res, ë§¥ë½: context };
    }

    before = input;
    context = parsed.ë§¥ë½ || context;
    let answer = parsed.ì‘ë‹µ || res;
    answer = textEF(answer);

    const schoolNameRegex = /[^\s~`!@#$%^&*()\-_=+\[\]{}\\|;:'",.<>/?]{2,}(ê³ ë“±í•™êµ|ì¤‘í•™êµ|ì´ˆë“±í•™êµ|ëŒ€í•™êµ|ëŒ€í•™)/g;

    const matchedSchools = Array.from(new Set(
      (answer.match(schoolNameRegex) || []).map(s => s.trim())
    ));

    console.log('í•™êµëª…:', matchedSchools);

    if (matchedSchools.length > 0) {
      $(`#${chat} .bubble`).innerHTML = '<div style = "width: 100%;display:flex;justify-content:center;"><div class="loading"></div></div><div  style = "width: 100%;display:flex;justify-content:center;"> ì¶”ê°€ì •ë³´ ì¡°íšŒì¤‘</div>';
      try {
        const schoolRes = await Efetch('school', {}, { schools: matchedSchools }, false);

        if (schoolRes && schoolRes.r) {
          matchedSchools.forEach(school => {
            if (school !== 'ê³¼í•™ê³ ë“±í•™êµ') {
              console.log(schools, schoolRes.r, school)
              schools[school] = schoolRes.r[school];
              const replaced = `<span style="color:blue;font-weight:bold" onclick="ss('${school}')" class = "schoolShow">${school}</span>`;
              answer = answer.replaceAll(`%${school}%`, replaced);
            }
          });
        }
      } catch (e) {
        console.error('í•™êµì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', e);
      }

      if(answer.includes('schoolShow')) answer += `<br><br>í•™êµ ì´ë¦„ì„ í´ë¦­í•˜ì‹œë©´ ë” ì •í™•í•œ ì •ë³´ë¥¼ ì œê³µí•´ë“œë¦´ê»˜ìš”!`
    }

    $(`#${chat} .bubble`).innerHTML = '';
    await typeText(`#${chat}.ai .bubble`, answer.replaceAll('%','').replaceAll('\\n','<br>').replaceAll('\n','<br>'));
    scrollTo();
  }
}

//ì´ˆê¸°ì‹¤í–‰
document.addEventListener('DOMContentLoaded', () => {
    if (!Storage.getSession('newPage')) {
      bigAlarm(['ì•ˆë…•í•˜ì„¸ìš”', '**ì„±ë‚¨.ai** ëŠ” **ì¤‘ì•™ê³ ë“±í•™êµ** í•™ìƒíŒ€ìœ¼ë¡œë¶€í„° ê°œë°œëœ í˜ì´ì§€ ì…ë‹ˆë‹¤.$br$$br$ë”°ë¼ì„œ ì•„ì§ ë‹¤ì–‘í•œ ë°©ë©´ì—ì„œ ë¶€ì¡±í•  ìˆ˜ ìˆìŒ ì–‘í•´ ë¶€íƒë“œë¦½ë‹ˆë‹¤.']);
      Storage.setSession('newPage', false);
    }
  
    makeChat(`ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì„±ë‚¨ì‹œ ì‹œë¯¼ë“¤ì„ ìœ„í•˜ì—¬ ë§Œë“¤ì–´ì§„ **ì„±ë‚¨.ai** ì…ë‹ˆë‹¤!ğŸ˜„<br> ì„±ë‚¨ì‹œì— ê´€í•œ ì§ˆë¬¸ì´ë‚˜ ì§„ë¡œ/ì·¨ì—…ì— ê´€ë ¨ëœ êµ¼ê¸ˆì¦ì„ í¸í•˜ê²Œ ë§ì”€í•´ì£¼ì„¸ìš”! ë‹¹ì‹ ì—ê²Œ ì¡°ê¸ˆì´ë¼ë„ ë„ì›€ì´ ë  ìˆ˜ ìˆëŠ” ë‹µë³€ì„ ë“œë¦¬ê² ìŠµë‹ˆë‹¤! $br$$br$ <div style = "color:blue" onclick = '$("#sideUp").click()'>ê°œë°œìì— ëŒ€í•˜ì—¬</div>`, undefined, false, false);
    makeChat(`ìì£¼ í•˜ëŠ” ì§ˆë¬¸ <br> 
    <br><div class = "box" onclick = "$('textarea').value += this.innerText">ë‚˜ëŠ” ì¤‘í•™ìƒì¸ë°, ê³¼í•™ ì¤‘ì  í•™êµëŠ” ì–´ë””ì–´ë””ê°€ ìˆì„ê¹Œ?</div>
    <br><div class = "box" onclick = "$('textarea').value += this.innerText">ë‚˜ëŠ” ê³ ë“±í•™ìƒì¸ë°, ìš°ë¦¬ ì§€ì—­ì— ë‚˜ì˜ ì§„ë¡œì— ë§ëŠ” ì¼ìë¦¬ê°€ ìˆì„ê¹Œ?</div>
    <br><div class = "box" onclick = "$('textarea').value += this.innerText">ë‚˜ëŠ” ì„±ì¸ì´ì•¼. í˜¹ì‹œ ìš°ë¦¬ ì§€ì—­ì— ë‚´ ë¶„ì•¼ì— ë§ëŠ” ì¼ìì´ê°€ ìˆì„ê¹Œ?</div>
    <br><div class = "box" onclick = "$('textarea').value += this.innerText">ìš°ë¦¬ì§€ì—­ì—ëŠ” ë¬´ìŠ¨ ì´ˆë“±í•™êµê°€ ìˆì„ê¹Œ?</div>
    <br><div class = "box" onclick = "$('textarea').value += this.innerText">ì„±ë‚¨ì‹œì˜ ìœ ëª…í•œ ê¸°ì—… ëª©ë¡ì„ ì•Œë ¤ì¤˜</div>
    <br><div class = "box" onclick = "$('textarea').value += this.innerText">ì„±ë‚¨ì‹œì˜ ë§›ì§‘ì„ ì•Œë ¤ì¤˜</div>
    `, undefined, false,false);
    
    start();
  });

function useSchoolInfo(obj){
let orgObj = obj
obj = schools[obj.replaceAll('$sp$','')]
if (obj == null) return orgObj
let r = '';
r+=`#${insertSpAt(obj.SCHUL_NM)}#$br$$br$`;
r+=`**ì†Œì† êµìœ¡ì²­ : ** ${obj.ATPT_OFCDC_SC_NM||'ì •ë³´ì—†ìŒ'}$br$`;
r+=`**ê³µí•™ ì—¬ë¶€ : ** ${obj.COEDU_SC_NM||'ì •ë³´ì—†ìŒ'}$br$`;
r+=`**í•™êµ ìœ í˜• : ** ${obj.FOND_SC_NM||'ì •ë³´ì—†ìŒ'}$br$`;
r+=`**í•™êµ ì¢…ë¥˜ : ** ${obj.HS_SC_NM||'ì •ë³´ì—†ìŒ'}$br$$br$`;
r+=`**ë¬¸ì˜ ì „í™” : ** ${obj.ORG_TELNO||'ì •ë³´ì—†ìŒ'}$br$`;
r+=`**í™ˆí˜ì´ì§€ : ** ${obj.HMPG_ADRES||'ì •ë³´ì—†ìŒ'}$br$`;
return r;
}

function insertSpAt(str) {
  const pos = Math.floor(Math.random() * (str.length));
  return str.slice(0, pos) + '$sp$' + str.slice(pos);
}

function ss(s){
  makeChat(`ë”ìš± ì •í™•í•œ í•™êµ ì •ë³´ë¥¼ ì•Œì•„ë´¤ì–´ìš” : $br$ ${useSchoolInfo(s)}`)
}

function aboutMe(){
  makeChat(`
  #ì¤‘ì•™ê³ ë“±í•™êµ 1í•™ë…„ 9ë°˜ í•™ìƒíŒ€#$br$$br$
  **ìë£Œì¡°ì‚¬ ë° ê³„íš** : $br$__10913ê¹€ëŒ€ì€__$br$__10923ì´ì¤€ìš°__$br$$br$
  **í”Œë«í¼ ê°œë°œ** : $br$__10923ì´ì¤€ìš°__$br$
  (ëª¨ë“  ì½”ë“œ ë° ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ê³  í”Œë«í¼ì„ êµ¬ì¶•í•¨)$br$$br$
  --ì„±ë‚¨.ai-- ëŠ” **ì œë¯¸ë‚˜ì´ API**ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‘ë™í•˜ëŠ” ai í”Œë«í¼ì…ë‹ˆë‹¤.$br$
  ì¼ì •í•œ ì •ì œë¥¼ í†µí•˜ì—¬ ì œë¯¸ë‚˜ì´ì˜ ì‘ë‹µì„ ì¡°ì •í•˜ê³ , í•´ë‹¹ ì‘ë‹µê³¼ ì™¸ë¶€ ì •ë³´ë¥¼ ì¡°í•©í•˜ì—¬$br$
  ì‚¬ìš©ìì—ê²Œ ì„±ë‚¨ì‹œì— ê´€í•œ ìƒë‹´ì„ ì§„í–‰í•˜ëŠ” ê²ƒì„ ëª©ì ì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.
  `)
}
</script>

</body>
</html>

